/*
 * Decompiled with CFR 0_132.
 */
package com.itextpdf.text.pdf.parser;

import com.itextpdf.text.error_messages.MessageLocalization;
import com.itextpdf.text.pdf.PdfArray;
import com.itextpdf.text.pdf.PdfDictionary;
import com.itextpdf.text.pdf.PdfName;
import com.itextpdf.text.pdf.PdfNumber;
import com.itextpdf.text.pdf.PdfObject;
import com.itextpdf.text.pdf.PdfReader;
import com.itextpdf.text.pdf.parser.FilteredTextRenderListener;
import com.itextpdf.text.pdf.parser.MarkedContentRenderFilter;
import com.itextpdf.text.pdf.parser.PdfContentStreamProcessor;
import com.itextpdf.text.pdf.parser.RenderFilter;
import com.itextpdf.text.pdf.parser.RenderListener;
import com.itextpdf.text.pdf.parser.SimpleTextExtractionStrategy;
import com.itextpdf.text.pdf.parser.TextExtractionStrategy;
import com.itextpdf.text.xml.XMLUtil;
import java.io.IOException;
import java.io.OutputStream;
import java.io.OutputStreamWriter;
import java.io.PrintWriter;
import java.io.Writer;
import java.util.Set;

public class TaggedPdfReaderTool {
    protected PrintWriter out;
    protected PdfReader reader;

    private static String fixTagName(String string2) {
        StringBuilder stringBuilder = new StringBuilder();
        for (int i = 0; i < string2.length(); ++i) {
            boolean bl;
            boolean bl2;
            char c;
            block9 : {
                boolean bl3;
                block12 : {
                    block11 : {
                        block10 : {
                            c = string2.charAt(i);
                            bl3 = true;
                            bl = c == ':' || c >= 'A' && c <= 'Z' || c == '_' || c >= 'a' && c <= 'z' || c >= '\u00c0' && c <= '\u00d6' || c >= '\u00d8' && c <= '\u00f6' || c >= '\u00f8' && c <= '\u02ff' || c >= '\u0370' && c <= '\u037d' || c >= '\u037f' && c <= '\u1fff' || c >= '\u200c' && c <= '\u200d' || c >= '\u2070' && c <= '\u218f' || c >= '\u2c00' && c <= '\u2fef' || c >= '\u3001' && c <= '\ud7ff' || c >= '\uf900' && c <= '\ufdcf' || c >= '\ufdf0' && c <= '\ufffd';
                            bl2 = bl3;
                            if (c == '-') break block9;
                            bl2 = bl3;
                            if (c == '.') break block9;
                            if (c < 48) break block10;
                            bl2 = bl3;
                            if (c <= 57) break block9;
                        }
                        bl2 = bl3;
                        if (c == 183) break block9;
                        if (c < 768) break block11;
                        bl2 = bl3;
                        if (c <= 879) break block9;
                    }
                    if (c < 8255) break block12;
                    bl2 = bl3;
                    if (c <= 8256) break block9;
                }
                bl2 = bl ? bl3 : false;
            }
            if (i == 0) {
                if (!bl) {
                    c = '_';
                }
            } else if (!bl2) {
                c = '-';
            }
            stringBuilder.append(c);
        }
        return stringBuilder.toString();
    }

    public void convertToXml(PdfReader pdfReader, OutputStream outputStream) throws IOException {
        this.convertToXml(pdfReader, outputStream, "UTF-8");
    }

    public void convertToXml(PdfReader object, OutputStream outputStream, String string2) throws IOException {
        this.reader = object;
        this.out = new PrintWriter(new OutputStreamWriter(outputStream, string2));
        if ((object = object.getCatalog().getAsDict(PdfName.STRUCTTREEROOT)) == null) {
            throw new IOException(MessageLocalization.getComposedMessage("no.structtreeroot.found", new Object[0]));
        }
        this.inspectChild(object.getDirectObject(PdfName.K));
        this.out.flush();
        this.out.close();
    }

    public void inspectChild(PdfObject pdfObject) throws IOException {
        if (pdfObject == null) {
            return;
        }
        if (pdfObject instanceof PdfArray) {
            this.inspectChildArray((PdfArray)pdfObject);
            return;
        }
        if (pdfObject instanceof PdfDictionary) {
            this.inspectChildDictionary((PdfDictionary)pdfObject);
        }
    }

    public void inspectChildArray(PdfArray pdfArray) throws IOException {
        if (pdfArray == null) {
            return;
        }
        for (int i = 0; i < pdfArray.size(); ++i) {
            this.inspectChild(pdfArray.getDirectObject(i));
        }
    }

    public void inspectChildDictionary(PdfDictionary pdfDictionary) throws IOException {
        this.inspectChildDictionary(pdfDictionary, false);
    }

    public void inspectChildDictionary(PdfDictionary pdfDictionary, boolean bl) throws IOException {
        if (pdfDictionary == null) {
            return;
        }
        Object object = pdfDictionary.getAsName(PdfName.S);
        if (object != null) {
            PdfObject pdfObject;
            object = PdfName.decodeName(object.toString());
            String string2 = TaggedPdfReaderTool.fixTagName((String)object);
            this.out.print("<");
            this.out.print(string2);
            if (bl && (pdfObject = pdfDictionary.getAsDict(PdfName.A)) != null) {
                for (PdfName pdfName : pdfObject.getKeys()) {
                    this.out.print(' ');
                    PdfObject pdfObject2 = PdfReader.getPdfObject(pdfObject.get(pdfName));
                    this.out.print(this.xmlName(pdfName));
                    this.out.print("=\"");
                    this.out.print(pdfObject2.toString());
                    this.out.print("\"");
                }
            }
            this.out.print(">");
            pdfObject = pdfDictionary.get(PdfName.ALT);
            if (pdfObject != null && pdfObject.toString() != null) {
                this.out.print("<alt><![CDATA[");
                this.out.print(pdfObject.toString().replaceAll("[\\000]*", ""));
                this.out.print("]]></alt>");
            }
            if ((pdfObject = pdfDictionary.getAsDict(PdfName.PG)) != null) {
                this.parseTag((String)object, pdfDictionary.getDirectObject(PdfName.K), (PdfDictionary)pdfObject);
            }
            this.inspectChild(pdfDictionary.getDirectObject(PdfName.K));
            this.out.print("</");
            this.out.print(string2);
            this.out.println(">");
            return;
        }
        this.inspectChild(pdfDictionary.getDirectObject(PdfName.K));
    }

    public void parseTag(String object, PdfObject pdfObject, PdfDictionary pdfDictionary) throws IOException {
        boolean bl = pdfObject instanceof PdfNumber;
        if (bl) {
            object = new MarkedContentRenderFilter(((PdfNumber)pdfObject).intValue());
            object = new FilteredTextRenderListener(new SimpleTextExtractionStrategy(), new RenderFilter[]{object});
            new PdfContentStreamProcessor((RenderListener)object).processContent(PdfReader.getPageContent(pdfDictionary), pdfDictionary.getAsDict(PdfName.RESOURCES));
            this.out.print(XMLUtil.escapeXML(object.getResultantText(), true));
            return;
        }
        if (pdfObject instanceof PdfArray) {
            pdfObject = (PdfArray)pdfObject;
            int n = pdfObject.size();
            for (int i = 0; i < n; ++i) {
                this.parseTag((String)object, pdfObject.getPdfObject(i), pdfDictionary);
                if (i >= n - 1) continue;
                this.out.println();
            }
        } else if (pdfObject instanceof PdfDictionary) {
            pdfObject = (PdfDictionary)pdfObject;
            this.parseTag((String)object, pdfObject.getDirectObject(PdfName.MCID), pdfObject.getAsDict(PdfName.PG));
        }
    }

    protected String xmlName(PdfName object) {
        object = object.toString().replaceFirst("/", "");
        StringBuilder stringBuilder = new StringBuilder();
        stringBuilder.append(Character.toLowerCase(object.charAt(0)));
        stringBuilder.append(object.substring(1));
        return stringBuilder.toString();
    }
}


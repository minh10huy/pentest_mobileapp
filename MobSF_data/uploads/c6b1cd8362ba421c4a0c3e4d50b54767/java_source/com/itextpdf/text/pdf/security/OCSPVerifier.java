/*
 * Decompiled with CFR 0_132.
 * 
 * Could not load the following classes:
 *  org.spongycastle.asn1.ASN1ObjectIdentifier
 *  org.spongycastle.asn1.ocsp.OCSPObjectIdentifiers
 *  org.spongycastle.cert.X509CertificateHolder
 *  org.spongycastle.cert.jcajce.JcaX509CertificateConverter
 *  org.spongycastle.cert.ocsp.BasicOCSPResp
 *  org.spongycastle.cert.ocsp.CertificateID
 *  org.spongycastle.cert.ocsp.CertificateStatus
 *  org.spongycastle.cert.ocsp.OCSPException
 *  org.spongycastle.cert.ocsp.SingleResp
 *  org.spongycastle.operator.ContentVerifierProvider
 *  org.spongycastle.operator.DigestCalculatorProvider
 *  org.spongycastle.operator.OperatorCreationException
 *  org.spongycastle.operator.bc.BcDigestCalculatorProvider
 *  org.spongycastle.operator.jcajce.JcaContentVerifierProviderBuilder
 */
package com.itextpdf.text.pdf.security;

import com.itextpdf.text.log.Logger;
import com.itextpdf.text.log.LoggerFactory;
import com.itextpdf.text.pdf.security.CRLVerifier;
import com.itextpdf.text.pdf.security.CertificateUtil;
import com.itextpdf.text.pdf.security.CertificateVerifier;
import com.itextpdf.text.pdf.security.OcspClientBouncyCastle;
import com.itextpdf.text.pdf.security.RootStoreVerifier;
import com.itextpdf.text.pdf.security.VerificationException;
import com.itextpdf.text.pdf.security.VerificationOK;
import java.io.IOException;
import java.io.Serializable;
import java.math.BigInteger;
import java.security.GeneralSecurityException;
import java.security.KeyStore;
import java.security.KeyStoreException;
import java.security.PublicKey;
import java.security.cert.CRL;
import java.security.cert.Certificate;
import java.security.cert.CertificateParsingException;
import java.security.cert.X509CRL;
import java.security.cert.X509Certificate;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.Enumeration;
import java.util.Iterator;
import java.util.List;
import org.spongycastle.asn1.ASN1ObjectIdentifier;
import org.spongycastle.asn1.ocsp.OCSPObjectIdentifiers;
import org.spongycastle.cert.X509CertificateHolder;
import org.spongycastle.cert.jcajce.JcaX509CertificateConverter;
import org.spongycastle.cert.ocsp.BasicOCSPResp;
import org.spongycastle.cert.ocsp.CertificateID;
import org.spongycastle.cert.ocsp.CertificateStatus;
import org.spongycastle.cert.ocsp.OCSPException;
import org.spongycastle.cert.ocsp.SingleResp;
import org.spongycastle.operator.ContentVerifierProvider;
import org.spongycastle.operator.DigestCalculatorProvider;
import org.spongycastle.operator.OperatorCreationException;
import org.spongycastle.operator.bc.BcDigestCalculatorProvider;
import org.spongycastle.operator.jcajce.JcaContentVerifierProviderBuilder;

public class OCSPVerifier
extends RootStoreVerifier {
    protected static final Logger LOGGER = LoggerFactory.getLogger(OCSPVerifier.class);
    protected static final String id_kp_OCSPSigning = "1.3.6.1.5.5.7.3.9";
    protected List<BasicOCSPResp> ocsps;

    public OCSPVerifier(CertificateVerifier certificateVerifier, List<BasicOCSPResp> list) {
        super(certificateVerifier);
        this.ocsps = list;
    }

    public BasicOCSPResp getOcspResponse(X509Certificate x509Certificate, X509Certificate arrsingleResp) {
        if (x509Certificate == null && arrsingleResp == null) {
            return null;
        }
        if ((x509Certificate = new OcspClientBouncyCastle().getBasicOCSPResp(x509Certificate, (X509Certificate)arrsingleResp, null)) == null) {
            return null;
        }
        arrsingleResp = x509Certificate.getResponses();
        for (int i = 0; i < arrsingleResp.length; ++i) {
            if (arrsingleResp[i].getCertStatus() != CertificateStatus.GOOD) continue;
            return x509Certificate;
        }
        return null;
    }

    public boolean isSignatureValid(BasicOCSPResp basicOCSPResp, Certificate certificate) {
        try {
            boolean bl = basicOCSPResp.isSignatureValid(new JcaContentVerifierProviderBuilder().setProvider("BC").build(certificate.getPublicKey()));
            return bl;
        }
        catch (OperatorCreationException operatorCreationException) {
            return false;
        }
        catch (OCSPException oCSPException) {
            return false;
        }
    }

    /*
     * Unable to fully structure code
     * Enabled aggressive block sorting
     * Enabled unnecessary exception pruning
     * Enabled aggressive exception aggregation
     * Lifted jumps to return sites
     */
    public void isValidResponse(BasicOCSPResp var1_1, X509Certificate var2_4) throws GeneralSecurityException, IOException {
        block19 : {
            block20 : {
                block21 : {
                    block17 : {
                        var6_9 = this.isSignatureValid(var1_1 /* !! */ , (Certificate)var2_8) != false ? var2_8 : null;
                        var8_10 = var6_9;
                        if (var6_9 != null) ** GOTO lbl40
                        if (var1_1 /* !! */ .getCerts() != null) break block21;
                        var7_20 = var6_9;
                        if (this.rootStore == null) break block17;
                        try {
                            var8_10 = this.rootStore.aliases();
lbl9: // 3 sources:
                            var7_22 = var6_9;
                            if (!var8_10.hasMoreElements()) break block17;
                            var7_23 = (String)var8_10.nextElement();
                            if (!this.rootStore.isCertificateEntry(var7_23) || !(var5_14 = this.isSignatureValid(var1_1 /* !! */ , var7_24 = (X509Certificate)this.rootStore.getCertificate(var7_23)))) ** GOTO lbl9
                            break block17;
                        }
                        catch (KeyStoreException var1_2) {}
                        var7_25 = null;
                    }
                    var8_10 = var7_26;
                    if (var7_26 == null) {
                        throw new VerificationException((Certificate)var2_8, "OCSP response could not be verified");
                    }
                    ** GOTO lbl40
                    catch (GeneralSecurityException var7_28) {
                        ** GOTO lbl9
                    }
                }
                var8_10 = var1_1 /* !! */ .getCerts();
                var4_11 = ((X509CertificateHolder[])var8_10).length;
                var3_12 = 0;
                do lbl-1000: // 2 sources:
                {
                    var7_16 = var6_9;
                    if (var3_12 < var4_11) {
                        var7_17 = var8_10[var3_12];
                        var7_18 = new JcaX509CertificateConverter().getCertificate((X509CertificateHolder)var7_17);
                        var9_30 = var7_18.getExtendedKeyUsage();
                        if (var9_30 == null || !var9_30.contains("1.3.6.1.5.5.7.3.9") || !(var5_13 = this.isSignatureValid(var1_1 /* !! */ , var7_18))) break block18;
                    }
                    var8_10 = var7_19;
                    if (var7_19 == null) {
                        throw new VerificationException((Certificate)var2_8, "OCSP response could not be verified");
                    }
lbl40: // 4 sources:
                    var8_10.verify(var2_8.getPublicKey());
                    if (var8_10.getExtensionValue(OCSPObjectIdentifiers.id_pkix_ocsp_nocheck.getId()) != null) break block19;
                    var1_4 = CertificateUtil.getCRL((X509Certificate)var8_10);
                    break block20;
                    break;
                } while (true);
                catch (Exception var1_5) {}
                {
                    block18 : {
                        catch (Exception | CertificateParsingException var7_27) {}
                    }
                    ++var3_12;
                    ** while (true)
                }
                var1_6 = null;
            }
            if (var1_7 != null && var1_7 instanceof X509CRL) {
                var6_9 = new CRLVerifier(null, null);
                var6_9.setRootStore(this.rootStore);
                var6_9.setOnlineCheckingAllowed(this.onlineCheckingAllowed);
                var6_9.verify((X509CRL)var1_7, (X509Certificate)var8_10, (X509Certificate)var2_8, new Date());
                return;
            }
        }
        var8_10.checkValidity();
    }

    @Override
    public List<VerificationOK> verify(X509Certificate x509Certificate, X509Certificate x509Certificate2, Date date) throws GeneralSecurityException, IOException {
        int n;
        int n2;
        ArrayList<VerificationOK> arrayList = new ArrayList<VerificationOK>();
        Object object = this.ocsps;
        boolean bl = false;
        if (object != null) {
            object = this.ocsps.iterator();
            n2 = 0;
            do {
                n = n2++;
                if (object.hasNext()) {
                    if (!this.verify((BasicOCSPResp)object.next(), x509Certificate, x509Certificate2, date)) continue;
                    continue;
                }
                break;
            } while (true);
        } else {
            n = 0;
        }
        boolean bl2 = bl;
        n2 = n;
        if (this.onlineCheckingAllowed) {
            bl2 = bl;
            n2 = n;
            if (n == 0) {
                bl2 = bl;
                n2 = n;
                if (this.verify(this.getOcspResponse(x509Certificate, x509Certificate2), x509Certificate, x509Certificate2, date)) {
                    n2 = n + 1;
                    bl2 = true;
                }
            }
        }
        object = LOGGER;
        Serializable serializable = new StringBuilder();
        serializable.append("Valid OCSPs found: ");
        serializable.append(n2);
        object.info(serializable.toString());
        if (n2 > 0) {
            serializable = this.getClass();
            StringBuilder stringBuilder = new StringBuilder();
            stringBuilder.append("Valid OCSPs Found: ");
            stringBuilder.append(n2);
            object = bl2 ? " (online)" : "";
            stringBuilder.append((String)object);
            arrayList.add(new VerificationOK(x509Certificate, (Class<? extends CertificateVerifier>)serializable, stringBuilder.toString()));
        }
        if (this.verifier != null) {
            arrayList.addAll(this.verifier.verify(x509Certificate, x509Certificate2, date));
        }
        return arrayList;
    }

    /*
     * Enabled aggressive block sorting
     * Enabled unnecessary exception pruning
     * Enabled aggressive exception aggregation
     */
    public boolean verify(BasicOCSPResp basicOCSPResp, X509Certificate x509Certificate, X509Certificate x509Certificate2, Date date) throws GeneralSecurityException, IOException {
        if (basicOCSPResp == null) {
            return false;
        }
        SingleResp[] arrsingleResp = basicOCSPResp.getResponses();
        int n = 0;
        X509Certificate x509Certificate3 = x509Certificate2;
        do {
            if (n >= arrsingleResp.length) {
                return false;
            }
            if (x509Certificate.getSerialNumber().equals(arrsingleResp[n].getCertID().getSerialNumber())) {
                void var6_12;
                Date date2;
                block11 : {
                    void var6_8;
                    x509Certificate2 = var6_8;
                    if (var6_8 == null) {
                        x509Certificate2 = x509Certificate;
                    }
                    try {
                        if (arrsingleResp[n].getCertID().matchesIssuer(new X509CertificateHolder(x509Certificate2.getEncoded()), (DigestCalculatorProvider)new BcDigestCalculatorProvider())) break block11;
                        LOGGER.info("OCSP: Issuers doesn't match.");
                        X509Certificate x509Certificate4 = x509Certificate2;
                    }
                    catch (OCSPException oCSPException) {
                        X509Certificate x509Certificate5 = x509Certificate2;
                    }
                }
                Date date3 = date2 = arrsingleResp[n].getNextUpdate();
                if (date2 == null) {
                    Date date4 = new Date(arrsingleResp[n].getThisUpdate().getTime() + 180000L);
                    LOGGER.info(String.format("No 'next update' for OCSP Response; assuming %s", date4));
                }
                if (date.after((Date)var6_12)) {
                    LOGGER.info(String.format("OCSP no longer valid: %s after %s", date, var6_12));
                    X509Certificate x509Certificate6 = x509Certificate2;
                } else {
                    X509Certificate x509Certificate7 = x509Certificate2;
                    if (arrsingleResp[n].getCertStatus() == CertificateStatus.GOOD) {
                        this.isValidResponse(basicOCSPResp, x509Certificate2);
                        return true;
                    }
                }
            }
            ++n;
        } while (true);
    }

    /*
     * Enabled force condition propagation
     * Lifted jumps to return sites
     */
    @Deprecated
    public boolean verifyResponse(BasicOCSPResp basicOCSPResp, X509Certificate x509Certificate) {
        try {
            this.isValidResponse(basicOCSPResp, x509Certificate);
            return true;
        }
        catch (Exception exception) {
            return false;
        }
    }
}


/*
 * Decompiled with CFR 0_132.
 */
package com.itextpdf.text.pdf.codec;

import com.itextpdf.text.ExceptionConverter;
import com.itextpdf.text.Image;
import com.itextpdf.text.ImgRaw;
import com.itextpdf.text.Utilities;
import com.itextpdf.text.error_messages.MessageLocalization;
import com.itextpdf.text.pdf.PdfArray;
import com.itextpdf.text.pdf.PdfDictionary;
import com.itextpdf.text.pdf.PdfName;
import com.itextpdf.text.pdf.PdfNumber;
import com.itextpdf.text.pdf.PdfObject;
import com.itextpdf.text.pdf.PdfString;
import java.io.BufferedInputStream;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.DataInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.URL;
import java.util.ArrayList;

public class GifImage {
    protected static final int MaxStackSize = 4096;
    protected int bgColor;
    protected int bgIndex;
    protected byte[] block;
    protected int blockSize;
    protected int delay;
    protected int dispose;
    protected ArrayList<GifFrame> frames;
    protected byte[] fromData;
    protected URL fromUrl;
    protected boolean gctFlag;
    protected int height;
    protected int ih;
    protected DataInputStream in;
    protected boolean interlace;
    protected int iw;
    protected int ix;
    protected int iy;
    protected boolean lctFlag;
    protected int lctSize;
    protected int m_bpc;
    protected byte[] m_curr_table;
    protected int m_gbpc;
    protected byte[] m_global_table;
    protected int m_line_stride;
    protected byte[] m_local_table;
    protected byte[] m_out;
    protected int pixelAspect;
    protected byte[] pixelStack;
    protected byte[] pixels;
    protected short[] prefix;
    protected byte[] suffix;
    protected int transIndex;
    protected boolean transparency;
    protected int width;

    public GifImage(InputStream inputStream) throws IOException {
        this.block = new byte[256];
        this.blockSize = 0;
        this.dispose = 0;
        this.transparency = false;
        this.delay = 0;
        this.frames = new ArrayList();
        this.process(inputStream);
    }

    public GifImage(String string2) throws IOException {
        this(Utilities.toURL(string2));
    }

    /*
     * Loose catch block
     * Enabled aggressive block sorting
     * Enabled unnecessary exception pruning
     * Enabled aggressive exception aggregation
     * Lifted jumps to return sites
     */
    public GifImage(URL object) throws IOException {
        void var1_5;
        Object object2;
        block7 : {
            Object object3;
            this.block = new byte[256];
            this.blockSize = 0;
            this.dispose = 0;
            this.transparency = false;
            this.delay = 0;
            this.frames = new ArrayList();
            this.fromUrl = object;
            object2 = object.openStream();
            try {
                int n;
                object = new ByteArrayOutputStream();
                object3 = new byte[1024];
                while ((n = object2.read((byte[])object3)) != -1) {
                    object.write((byte[])object3, 0, n);
                }
                object2.close();
                object3 = new ByteArrayInputStream(object.toByteArray());
            }
            catch (Throwable throwable) {}
            try {
                object.flush();
                object.close();
                this.process((InputStream)object3);
                if (object3 == null) return;
            }
            catch (Throwable throwable) {
                object2 = object3;
            }
            object3.close();
            return;
            break block7;
            catch (Throwable throwable) {
                object2 = null;
            }
        }
        if (object2 == null) throw var1_5;
        object2.close();
        throw var1_5;
    }

    /*
     * Loose catch block
     * Enabled aggressive block sorting
     * Enabled unnecessary exception pruning
     * Enabled aggressive exception aggregation
     * Lifted jumps to return sites
     */
    public GifImage(byte[] object) throws IOException {
        void var2_5;
        block4 : {
            this.block = new byte[256];
            this.blockSize = 0;
            this.dispose = 0;
            this.transparency = false;
            this.delay = 0;
            this.frames = new ArrayList();
            this.fromData = object;
            Object var3_2 = null;
            object = new ByteArrayInputStream((byte[])object);
            try {
                this.process((InputStream)object);
                if (object == null) return;
            }
            catch (Throwable throwable) {}
            object.close();
            return;
            break block4;
            catch (Throwable throwable) {
                object = var3_2;
            }
        }
        if (object == null) throw var2_5;
        object.close();
        throw var2_5;
    }

    protected static int newBpc(int n) {
        switch (n) {
            default: {
                return 8;
            }
            case 3: {
                return 4;
            }
            case 1: 
            case 2: 
            case 4: 
        }
        return n;
    }

    protected boolean decodeImageData() throws IOException {
        int n = this.iw * this.ih;
        if (this.prefix == null) {
            this.prefix = new short[4096];
        }
        if (this.suffix == null) {
            this.suffix = new byte[4096];
        }
        if (this.pixelStack == null) {
            this.pixelStack = new byte[4097];
        }
        int n2 = this.iw;
        int n3 = this.m_bpc;
        int n4 = 8;
        this.m_line_stride = (n2 * n3 + 7) / 8;
        this.m_out = new byte[this.m_line_stride * this.ih];
        if (!this.interlace) {
            n4 = 1;
        }
        n2 = this.in.read();
        int n5 = 1 << n2;
        int n6 = n5 + 2;
        int n7 = (1 << ++n2) - 1;
        for (n3 = 0; n3 < n5; ++n3) {
            this.prefix[n3] = 0;
            this.suffix[n3] = (byte)n3;
        }
        int n8 = n2;
        int n9 = n6;
        int n10 = n7;
        int n11 = -1;
        int n12 = 0;
        int n13 = 0;
        int n14 = 0;
        int n15 = 0;
        int n16 = 0;
        int n17 = 0;
        int n18 = 0;
        int n19 = 1;
        int n20 = 0;
        n3 = n;
        block6 : do {
            int n21 = 0;
            n = n20;
            n20 = n10;
            int n22 = n12;
            while (n22 < n3) {
                int n23;
                block28 : {
                    int n24;
                    block30 : {
                        block26 : {
                            byte[] arrby;
                            byte by;
                            block29 : {
                                block27 : {
                                    if (n13 != 0) break block26;
                                    if (n14 < n8) {
                                        n10 = n15;
                                        if (n15 == 0) {
                                            n10 = this.readBlock();
                                            if (n10 <= 0) {
                                                return true;
                                            }
                                            n17 = 0;
                                        }
                                        n16 += (this.block[n17] & 255) << n14;
                                        n14 += 8;
                                        ++n17;
                                        n15 = n10 - 1;
                                        continue;
                                    }
                                    n10 = n16 & n20;
                                    n12 = n16 >> n8;
                                    n24 = n14 - n8;
                                    if (n10 > n9 || n10 == n5 + 1) break block6;
                                    if (n10 != n5) break block27;
                                    n16 = n2;
                                    n9 = n6;
                                    n20 = n7;
                                    n11 = -1;
                                    n23 = n13;
                                    n14 = n24;
                                    n10 = n12;
                                    n12 = n20;
                                    break block28;
                                }
                                if (n11 != -1) break block29;
                                this.pixelStack[n13] = this.suffix[n10];
                                n18 = n10;
                                n23 = n13 + 1;
                                n11 = n10;
                                n14 = n24;
                                n16 = n8;
                                n10 = n12;
                                n12 = n20;
                                break block28;
                            }
                            if (n10 == n9) {
                                arrby = this.pixelStack;
                                n16 = n13 + 1;
                                arrby[n13] = (byte)n18;
                                n14 = n11;
                                n18 = n10;
                                n13 = n16;
                            } else {
                                n14 = n10;
                                n18 = n10;
                            }
                            while (n14 > n5) {
                                this.pixelStack[n13] = this.suffix[n14];
                                n14 = this.prefix[n14];
                                ++n13;
                            }
                            n14 = this.suffix[n14] & 255;
                            if (n9 >= 4096) break block6;
                            arrby = this.pixelStack;
                            n23 = n13 + 1;
                            arrby[n13] = by = (byte)n14;
                            this.prefix[n9] = (short)n11;
                            this.suffix[n9] = by;
                            n13 = n9 + 1;
                            if ((n13 & n20) == 0) {
                                n16 = n8;
                                n10 = n20;
                                if (n13 < 4096) {
                                    n16 = n8 + 1;
                                    n10 = n20 + n13;
                                }
                            } else {
                                n10 = n20;
                                n16 = n8;
                            }
                            n11 = n14;
                            n8 = n18;
                            n14 = n24;
                            n20 = n12;
                            n18 = n11;
                            break block30;
                        }
                        n10 = n20;
                        n20 = n16;
                        n16 = n8;
                        n23 = n13;
                        n13 = n9;
                        n8 = n11;
                    }
                    n11 = n2;
                    ++n22;
                    this.setPixel(n21, n, this.pixelStack[--n23]);
                    if (++n21 >= this.iw) {
                        n2 = n9 = n + n4;
                        n = n19;
                        n21 = n4;
                        if (n9 >= this.ih) {
                            if (this.interlace) {
                                n9 = n4;
                                do {
                                    n = n19 + 1;
                                    n2 = 4;
                                    n4 = n9;
                                    switch (n) {
                                        default: {
                                            n2 = this.ih - 1;
                                            n4 = 0;
                                            break;
                                        }
                                        case 4: {
                                            n2 = 1;
                                            n4 = 2;
                                            break;
                                        }
                                        case 3: {
                                            n2 = 2;
                                            n4 = 4;
                                        }
                                        case 2: 
                                    }
                                    n19 = n;
                                    n9 = n4;
                                } while (n2 >= this.ih);
                                n21 = n4;
                            } else {
                                n = this.ih - 1;
                                n2 = n11;
                                n4 = 0;
                                n11 = n8;
                                n12 = n22;
                                n9 = n13;
                                n13 = n23;
                                n8 = n16;
                                n16 = n20;
                                n20 = n;
                                continue block6;
                            }
                        }
                        n24 = n2;
                        n2 = n11;
                        n11 = n8;
                        n12 = n22;
                        n9 = n13;
                        n13 = n23;
                        n8 = n16;
                        n16 = n20;
                        n19 = n;
                        n4 = n21;
                        n20 = n24;
                        continue block6;
                    }
                    n2 = n11;
                    n12 = n10;
                    n10 = n20;
                    n9 = n13;
                    n11 = n8;
                }
                n13 = n23;
                n8 = n16;
                n16 = n10;
                n20 = n12;
            }
            break;
        } while (true);
        return false;
    }

    public int getFrameCount() {
        return this.frames.size();
    }

    public int[] getFramePosition(int n) {
        GifFrame gifFrame = this.frames.get(n - 1);
        return new int[]{gifFrame.ix, gifFrame.iy};
    }

    public Image getImage(int n) {
        return this.frames.get((int)(n - 1)).image;
    }

    public int[] getLogicalScreen() {
        return new int[]{this.width, this.height};
    }

    void process(InputStream inputStream) throws IOException {
        this.in = new DataInputStream(new BufferedInputStream(inputStream));
        this.readHeader();
        this.readContents();
        if (this.frames.isEmpty()) {
            throw new IOException(MessageLocalization.getComposedMessage("the.file.does.not.contain.any.valid.image", new Object[0]));
        }
    }

    protected int readBlock() throws IOException {
        this.blockSize = this.in.read();
        if (this.blockSize <= 0) {
            this.blockSize = 0;
            return 0;
        }
        this.blockSize = this.in.read(this.block, 0, this.blockSize);
        return this.blockSize;
    }

    protected byte[] readColorTable(int n) throws IOException {
        byte[] arrby = new byte[(1 << GifImage.newBpc(n)) * 3];
        this.in.readFully(arrby, 0, (1 << n) * 3);
        return arrby;
    }

    protected void readContents() throws IOException {
        boolean bl = false;
        while (!bl) {
            int n = this.in.read();
            if (n != 33) {
                if (n != 44) {
                    bl = true;
                    continue;
                }
                this.readImage();
                continue;
            }
            n = this.in.read();
            if (n != 249) {
                if (n != 255) {
                    this.skip();
                    continue;
                }
                this.readBlock();
                this.skip();
                continue;
            }
            this.readGraphicControlExt();
        }
    }

    protected void readGraphicControlExt() throws IOException {
        this.in.read();
        int n = this.in.read();
        int n2 = this.dispose = (n & 28) >> 2;
        boolean bl = true;
        if (n2 == 0) {
            this.dispose = 1;
        }
        if ((n & 1) == 0) {
            bl = false;
        }
        this.transparency = bl;
        this.delay = this.readShort() * 10;
        this.transIndex = this.in.read();
        this.in.read();
    }

    protected void readHeader() throws IOException {
        StringBuilder stringBuilder = new StringBuilder("");
        for (int i = 0; i < 6; ++i) {
            stringBuilder.append((char)this.in.read());
        }
        if (!stringBuilder.toString().startsWith("GIF8")) {
            throw new IOException(MessageLocalization.getComposedMessage("gif.signature.nor.found", new Object[0]));
        }
        this.readLSD();
        if (this.gctFlag) {
            this.m_global_table = this.readColorTable(this.m_gbpc);
        }
    }

    protected void readImage() throws IOException {
        Object object;
        this.ix = this.readShort();
        this.iy = this.readShort();
        this.iw = this.readShort();
        this.ih = this.readShort();
        int n = this.in.read();
        boolean bl = (n & 128) != 0;
        this.lctFlag = bl;
        bl = (n & 64) != 0;
        this.interlace = bl;
        this.lctSize = 2 << (n &= 7);
        this.m_bpc = GifImage.newBpc(this.m_gbpc);
        if (this.lctFlag) {
            this.m_curr_table = this.readColorTable(++n);
            this.m_bpc = GifImage.newBpc(n);
        } else {
            this.m_curr_table = this.m_global_table;
        }
        if (this.transparency && this.transIndex >= this.m_curr_table.length / 3) {
            this.transparency = false;
        }
        if (this.transparency && this.m_bpc == 1) {
            object = new byte[12];
            System.arraycopy(this.m_curr_table, 0, object, 0, 6);
            this.m_curr_table = object;
            this.m_bpc = 2;
        }
        if (!this.decodeImageData()) {
            this.skip();
        }
        try {
            object = new ImgRaw(this.iw, this.ih, 1, this.m_bpc, this.m_out);
            Object object2 = new PdfArray();
            object2.add(PdfName.INDEXED);
            object2.add(PdfName.DEVICERGB);
            object2.add(new PdfNumber(this.m_curr_table.length / 3 - 1));
            object2.add(new PdfString(this.m_curr_table));
            PdfDictionary pdfDictionary = new PdfDictionary();
            pdfDictionary.put(PdfName.COLORSPACE, (PdfObject)object2);
            object.setAdditional(pdfDictionary);
            if (this.transparency) {
                object.setTransparency(new int[]{this.transIndex, this.transIndex});
            }
            object.setOriginalType(3);
            object.setOriginalData(this.fromData);
            object.setUrl(this.fromUrl);
            object2 = new GifFrame();
            object2.image = object;
            object2.ix = this.ix;
            object2.iy = this.iy;
            this.frames.add((GifFrame)object2);
            return;
        }
        catch (Exception exception) {
            throw new ExceptionConverter(exception);
        }
    }

    protected void readLSD() throws IOException {
        this.width = this.readShort();
        this.height = this.readShort();
        int n = this.in.read();
        boolean bl = (n & 128) != 0;
        this.gctFlag = bl;
        this.m_gbpc = (n & 7) + 1;
        this.bgIndex = this.in.read();
        this.pixelAspect = this.in.read();
    }

    protected int readShort() throws IOException {
        return this.in.read() | this.in.read() << 8;
    }

    protected void resetFrame() {
    }

    protected void setPixel(int n, int n2, int n3) {
        if (this.m_bpc == 8) {
            int n4 = this.iw;
            this.m_out[n + n4 * n2] = (byte)n3;
            return;
        }
        n2 = this.m_line_stride * n2 + n / (8 / this.m_bpc);
        int n5 = this.m_bpc;
        int n6 = 8 / this.m_bpc;
        int n7 = this.m_bpc;
        byte[] arrby = this.m_out;
        arrby[n2] = (byte)(n3 << 8 - n5 * (n % n6) - n7 | arrby[n2]);
    }

    protected void skip() throws IOException {
        do {
            this.readBlock();
        } while (this.blockSize > 0);
    }

    static class GifFrame {
        Image image;
        int ix;
        int iy;

        GifFrame() {
        }
    }

}

